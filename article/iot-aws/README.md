
# AWSとサーバーレスを用いたIoTデバイスの接続過程

こんにちは、icuco株式会社のエンジニア、古平です。

今回は私が、弊社サービスの午睡チェックセンサー、「touch＆care」でサーバーレスアーキテクチャーを採用した中で感じた、従来アーキテクチャーとは違う利点、欠点、対策等、そこで得られた知見も含めてまとめてみました。初めて記事を書くのですが、デジタル化が進む現代で注目されつつあるIoTに興味を持っているエンジニアの方に役立つ情報が発信できるといいなと思います。

## 目次

1. 「icuco®touch＆care」とは
2. IoTデバイスを構築する
  2-1. サーバーレスアーキテクチャーとは
  2-2. AWS上での構築
  2-3. AWS上に構築した利点
  2-4. 発生したトラブルと対策
3. 今後の活用

## 1. 「icuco®touch＆care」とは

生後0日から満1歳未満までの子どもたちに対して行われる、お昼寝時の「午睡チェック」。何人もの園児たちを保育士が一人一人手で確認して回り、紙に手書きで記録したものを5年間保管しています。

「icuco®touch＆care」は、子どもたちの体調を自動で記録し、異変があれば音と光でお知らせする午睡チェックセンサーです。

## 2. IoTデバイスを構築する

私自身が初めてIoTデバイス関連に携わったこともあり、膨大なデータをどのように処理するか？低コストに抑えつつ、いかに処理遅延を起こさずに環境を構築するか、ということにはかなりこだわりました。

まず、「touch＆care」の設計については、自分以外の誰もが一目見て理解できるシンプルさを意識しました。エンジニアはよく、いわゆる「自分の考える最高のアーキテクチャー」をやりがちですが、書いた本人はわかってもほかのエンジニアが読み取ることができないことがよくあります。後から参入してきたエンジニアがドキュメントなしにソースコードを読むことができシンプルで素直な設計が大事だと思っているので、常に意識しています。

通常のIoTアプリの開発はMacでIoTシミュレーターを立ち上げて作るものですが、Bluetoothは実機（iPhone）が必要でした。開発のたびにMacと実機を繋いで作業をしなければならず、とても大変で手間のかかる作業でしたが、初めての経験ということもあり、知見が広がりました。

### 2-1. サーバーレスアーキテクチャーとは

サーバーレスアーキテクチャーとは、従来から一般的だった EC2 などの仮想マシンやオンプレミス (物理) サーバーの代わりに Lambda などのプログラム (関数) 実行サービス (クラウドコンピューティングサービス) を使うことを指します。
子どもの体調に関わるIoTなので、センサーデータをローカル (iOS デバイスにインストールされた保育所アプリ内) で処理しています。インターネットを経由するのに比べて遅延が発生しにくく、これによって寝姿勢や体調異常がリアルタイムに画面上に反映されるのがこだわりの部分です。これを実現するためにサーバーレスアーキテクチャーを採用しています。

#### 利点

##### 1. EC2 のような仮想マシンの管理が不要になり、 Lambda であればビジネスの中核となるソフトウェアの開発に専念できる。

午睡チェックセンサーは子どもたちの命に関わるものなので、止まらずリアルタイムで体調を保育者へ伝えることを重要視しています。そのため、従来のアーキテクチャーはエンジニアが常に気にかけて整備や修正をする必要があり、処理が止まってしまう危険がありました。しかし、Lambdaであれば全自動で調整が可能なため、調整のために止まらず、処理が可能になりました。

##### 2. Lambda は負荷が高まっても全自動でスケールアウトしてくれるので基本的に落ちることがない。

また、データの処理容量についても従来のアーキテクチャーであれば、負荷が高まるとスケールを拡張させるためにわざわざ一度アーキテクチャーの動作を止めてアップデートしなければいけませんが、Lambdaでは止めずに自動で拡張して処理するため、データがたまるなど遅延のリスクもなく、使用できます。

##### 3. EC2 のような仮想マシンは起動したままになるので課金が高額になりがちだが、 Lambda はコードの実行にかかった時間数だけの課金になるので安くなることが多い。その時々に合わせた調整をしてくれるので、かかる費用も無駄に支払うこともなく、節約できました。

#### 問題点

上記にある通り、以前までのものよりもかなりデータ処理の面で改善されました。過負荷時にも落ちることなく、課金も安く対応ができるようになりました。今のところ問題点も見当たらず、対応できています。

## 2-2. AWS上での構築

私の専門は TypeScript, Node.js, React, GraphQL, AWS です。
その中でもTypeScriptを活かし、1秒間に約7000（人数×全保育所）のセンサーデータがアプリに降ってきても処理できるAWSを構築しました。
サーバーレスをAWS上に構築すると、下記の図のようになりました。

センサーデバイスが取得した体動や心拍数、体温などの計測データは Bluetooth Low Energy (BLE) 通信によって iOS デバイス (iPhone, iPad など) 上にインストールされた保育所用 iOS アプリケーション (以下「保育所アプリ」) に送信されます。保育所アプリでは受信したセンサーデータを元に午睡中の各幼児の寝姿勢の表示、うつ伏せ寝や無呼吸の警告を行います。保育士はそれらを助けに実際の寝姿勢や体調などを確定させます。それらの午睡データや幼児の情報などは AppSync で構築された GraphQL API サーバーを通じて DynamoDB に格納されます。

保育所アプリは並行してセンサーデータを IoT Core に飛ばして、 Data Firehose と Kinesis にルーティングします。 Data Firehose からは Lambda を発火させ、 Lambda 上でセンサーデータを CSV 形式に加工して S3 に保存します。 Kinesis では 2 つの Lambda をトリガー発火させ、 1 つ目はセンサーデータ上で幼児の発熱を検知したときに Pinpoint を呼び出して保護者用 iOS アプリケーション (以下「保護者アプリ」) にプッシュ通知を飛ばします。 2 つ目はセンサーデータから体温や心拍数などのデータを抜き出して DynamoDB をリアルタイムに更新し続けます。そのデータは保護者アプリから参照することができます。

そして保育所用ウェブアプリケーション (以下「保育所ウェブアプリ」) では AppSync を経由して DynamoDB に蓄積された幼児の情報の管理や午睡チェック表の出力が可能です。

## 2-3. AWS上に構築した利点

センサーデータはデータ量こそ少ないものの、データが飛んでくる頻度は数百ミリ秒単位と凄まじく、利用者が増えると莫大な量になります。 AWS が用意してくれている IoT 関連のサービスを使うことでよしなに処理してくれるので落ちることなく捌けています。

## 2-4. 発生したトラブルと対策

過負荷時に Kinesis の処理が追いつかなくなり Lambda によるリアルタイムデータ更新処理が遅延するという不具合が出たことがありました。 Kinesis のシャード数を増やす (課金してスペックを増強する) ことでこの問題を回避することができました。
DynamoDB には一括読み書き時の件数・容量制限（読み：100件、１MB　書き：25件、１MB）があるのですが、これを考慮した実装になっていない箇所が多々あり、いくつものバグを生んでいました。 AWS 公式 DynamoDB SDK をラップしたライブラリを独自実装することでこれらの制限を回避しました。

## 3. 今後の活用

現在の icuco が設計開発されたのは2019年で、基本設計は現在もそのまま踏襲しています。5年たった今でも変わらず使えているのは当時の基本設計の段階で熟考し、永く通用するものを選定してきたからです。しかし、最新のものと比べると陳腐化してしまう部分が多々でてきました。

現在、最新のアーキテクチャーを使ってフルスクラッチで設計し直しています。今後何年経っても通用する堅牢かつシンプルな設計にできるようがんばっていきたいと思います。
